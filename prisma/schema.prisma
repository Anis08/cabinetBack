// Prisma schema for user authentication
// You must run npx prisma migrate dev after editing this file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Medecin {
  id                  Int                  @id @default(autoincrement())
  email               String               @unique
  phoneNumber         String               @unique
  password            String
  fullName            String               @unique
  speciality          String
  bio                 String?
  price               Int?                 // Prix de consultation
  createdAt           DateTime             @default(now())
  patients            Patient[]
  rendezVous          RendezVous[]
  biologicalRequests  BiologicalRequest[]
  advertisements      Advertisement[]
  ordonnances         Ordonnance[]         
  demandeMedicaments  DemandeMedicament[]
}

enum Gender {
  Homme
  Femme
}

model Patient {
  id                  Int                  @id @default(autoincrement())
  phoneNumber         String               @unique
  fullName            String               @unique
  gender              Gender
  poids               Float?
  taille              Int?
  email               String?
  address             String?
  maladieChronique    String               @default("arthrose")
  dateOfBirth         DateTime
  bio                 String?
  createdAt           DateTime             @default(now())
  medecinId           Int
  medecin             Medecin              @relation(fields: [medecinId], references: [id], onDelete: Cascade)
  rendezVous          RendezVous[]
  biologicalRequests  BiologicalRequest[]
  complementaryExams  ComplementaryExam[]
  ordonnances         Ordonnance[]
}

enum RendezVousState {
  Scheduled
  Waiting
  InProgress
  Completed
  Cancelled
}

model RendezVous {
  id          Int             @id @default(autoincrement())
  date        DateTime
  patientId   Int
  medecinId   Int
  arrivalTime DateTime?
  startTime   DateTime?
  endTime     DateTime?
  state       RendezVousState @default(Scheduled)

  paid          Int     @default(0)
  note          String?
  poids         Float?
  pcm           Float?
  imc           Float?
  pulse         Int?
  paSystolique  Int?
  paDiastolique Int?

  patient     Patient       @relation(fields: [patientId], references: [id])
  medecin     Medecin       @relation(fields: [medecinId], references: [id])
  ordonnances Ordonnance[]

  @@unique([patientId, medecinId, date])
}

enum BiologicalRequestStatus {
  EnCours
  Completed
}

model BiologicalRequest {
  id              Int                      @id @default(autoincrement())
  requestNumber   String                   @unique @default(cuid())
  patientId       Int
  medecinId       Int
  sampleTypes     String[] // Array of sample types (Sang, Urine, Selles, Autre)
  requestedExams  String[] // Array of exam types
  results         Json?    // JSON object with exam results { "examName": "value" }
  status          BiologicalRequestStatus  @default(EnCours)
  samplingDate    DateTime?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  patient Patient @relation(fields: [patientId], references: [id])
  medecin Medecin @relation(fields: [medecinId], references: [id])
}

enum AdType {
  image
  video
}

enum AdPosition {
  top
  bottom
}

model Advertisement {
  id          Int         @id @default(autoincrement())
  medecinId   Int
  title       String
  type        AdType
  fileUrl     String
  dateFrom    DateTime
  dateTo      DateTime
  duration    Int         @default(5) // seconds
  position    AdPosition  @default(top)
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  medecin Medecin @relation(fields: [medecinId], references: [id])
}

model ComplementaryExam {
  id          Int         @id @default(autoincrement())
  patientId   Int
  type        String      // Type of exam (Échographie rénale, Scanner/IRM, etc.)
  description String      @db.Text
  date        DateTime
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  patient     Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  files       ExamFile[]
}

model ExamFile {
  id        Int      @id @default(autoincrement())
  examId    Int
  fileName  String
  fileUrl   String
  fileType  String   // MIME type
  fileSize  Int      // Size in bytes
  uploadDate DateTime @default(now())
  
  exam      ComplementaryExam @relation(fields: [examId], references: [id], onDelete: Cascade)
}

// Médicaments
model Medicament {
  id              Int                   @id @default(autoincrement())
  nom             String                @unique
  moleculeMereId    Int
  type            String                // Antalgique, Antibiotique, etc.
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  dosages        Dosage[]
  moleculeMereRel  moleculeMere         @relation(fields: [moleculeMereId], references: [id], onDelete: Cascade)

  // Relations
  ordonnanceMedicaments OrdonnanceMedicament[]
  demandeMedicaments    DemandeMedicament[]    @relation("MedicamentDemandes")
   // Un médicament unique par combinaison nom+dosage+forme
  @@index([nom])
  @@index([moleculeMereId])
  @@index([type])
}


model Dosage {
  id            Int         @id @default(autoincrement())
  valeur        String       // ex: "500 mg", "1 g/125 mg"
  medicamentId  Int
  Medicament    Medicament   @relation(fields: [medicamentId], references: [id])
}

model moleculeMere {
  id          Int      @id @default(autoincrement())
  nom         String   @unique
  medicaments Medicament[]
}

// Ordonnances
model Ordonnance {
  id                Int                   @id @default(autoincrement())
  patientId         Int
  medecinId         Int
  rendezVousId      Int?                  // Optionnel: lié à un RDV
  dateCreation      DateTime              @default(now())
  dateValidite      DateTime?             // Date d'expiration de l'ordonnance
  note              String?               @db.Text
  
  // Relations
  patient           Patient               @relation(fields: [patientId], references: [id], onDelete: Cascade)
  medecin           Medecin               @relation(fields: [medecinId], references: [id])
  rendezVous        RendezVous?           @relation(fields: [rendezVousId], references: [id], onDelete: SetNull)
  medicaments       OrdonnanceMedicament[]
  
  @@index([patientId])
  @@index([medecinId])
  @@index([dateCreation])
}

// Table de liaison entre Ordonnance et Medicament (Many-to-Many avec données supplémentaires)
model OrdonnanceMedicament {
  id              Int         @id @default(autoincrement())
  ordonnanceId    Int
  medicamentId    Int
  posologie       String      // "1 comprimé 3 fois par jour"
  duree           String?     // "7 jours", "1 mois"
  instructions    String?     @db.Text // Instructions spécifiques
  
  ordonnance      Ordonnance  @relation(fields: [ordonnanceId], references: [id], onDelete: Cascade)
  medicament      Medicament  @relation(fields: [medicamentId], references: [id])
  
  @@unique([ordonnanceId, medicamentId])
}

// Demandes d'ajout de médicament
enum DemandeMedicamentStatus {
  EnAttente
  Acceptee
  Rejetee
}

model DemandeMedicament {
  id              Int                     @id @default(autoincrement())
  nom             String
  dosage          String
  forme           String
  fabricant       String
  moleculeMere    String
  type            String
  frequence       String?
  medecinId       Int                     // Médecin qui a fait la demande
  status          DemandeMedicamentStatus @default(EnAttente)
  motifRejet      String?                 // Si rejeté, raison du rejet
  medicamentId    Int?                    // Si accepté, ID du médicament créé
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  traitePar       Int?                    // ID de l'admin/medecin qui a traité
  dateTraitement  DateTime?               // Date de traitement de la demande
  
  medecin         Medecin                 @relation(fields: [medecinId], references: [id], onDelete: Cascade)
  medicament      Medicament?             @relation("MedicamentDemandes", fields: [medicamentId], references: [id], onDelete: SetNull)
  
  @@index([medecinId])
  @@index([status])
  @@index([createdAt])
}
